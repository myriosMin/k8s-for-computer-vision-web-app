{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto">
  <h1 class="text-3xl font-semibold text-white mb-6">Data Loading & Training</h1>

  <!-- Model Status -->
  <div id="modelStatus" class="border border-slate-700 rounded-lg p-6 bg-slate-800 shadow-sm mb-6">
    <h2 class="text-lg font-semibold text-white mb-3">📊 Model Deployment Status</h2>
    <div id="statusContent" class="text-sm text-slate-300">
      Loading model status...
    </div>
  </div>

  <!-- Batch Upload -->
  <form id="uploadForm"
        class="border border-slate-700 rounded-lg p-6 bg-slate-800 shadow-sm hover:shadow-md transition">
    <label class="block mb-3 text-sm font-medium text-slate-300">Batch upload (drag & drop or select a zipped file)</label>
    <div id="uploadStatus" class="hidden mb-3 p-2 rounded text-sm"></div>
    <input id="fileInput" class="w-full border border-slate-600 p-2 bg-slate-900 text-slate-100 rounded"
           type="file" name="file" accept=".zip" />
    <button id="uploadBtn" class="mt-4 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded" type="button">
      Upload
    </button>
  </form>

  <!-- Configuration + Results -->
  <div class="grid md:grid-cols-2 gap-6 mt-8">
    <!-- Model Config -->
    <div class="border border-slate-700 rounded-lg p-6 bg-slate-800 shadow-sm hover:shadow-md transition">
      <h2 class="text-xl font-semibold text-white mb-4">Training Configuration</h2>

      <div class="mb-4 p-3 bg-slate-700 rounded-lg">
        <p class="text-sm text-slate-300 mb-2">
          <strong>Model:</strong> Fine-tuning existing <code class="text-blue-400">best.pt</code> model
        </p>
        <p class="text-sm text-slate-300">
          <strong>Image Size:</strong> Fixed at <code class="text-blue-400">640px</code> (matches training data)
        </p>
      </div>

      <label class="block text-sm text-slate-400 mb-1">Epochs</label>
      <input id="epochs" class="border border-slate-600 p-2 w-full bg-slate-900 text-white rounded mb-4"
             type="number" value="10" min="1" max="100" />

      <label class="block text-sm text-slate-400 mb-1">Batch Size</label>
      <input id="batch" class="border border-slate-600 p-2 w-full bg-slate-900 text-white rounded mb-6"
             type="number" value="8" min="1" max="32" />

      <div class="flex flex-wrap gap-3">
        <button id="btnPreprocess" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded">
          Run Preprocess
        </button>
        <button id="btnTrain" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded">
          Start Training
        </button>
      </div>

      <!-- Loading bar -->
      <div id="jobLoading" class="hidden mt-4 w-full bg-slate-700 rounded h-2 overflow-hidden">
        <div class="bg-indigo-500 h-2 animate-pulse" style="width: 100%"></div>
      </div>
    </div>

    <!-- Results -->
    <div class="border border-slate-700 rounded-lg p-6 bg-slate-800 shadow-sm">
      <h2 class="text-xl font-semibold text-white mb-4">Latest Results / Metrics</h2>
      <div id="metrics" class="text-sm text-slate-400">
        No recent training run. Train logs & mAP/PR curves will appear here.
      </div>
    </div>
  </div>
</div>

<script>
  // Upload handling
  function showUploadStatus(message, isError = false) {
    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.textContent = message;
    statusDiv.className = `mb-3 p-2 rounded text-sm ${isError ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'}`;
    statusDiv.classList.remove('hidden');
  }

  document.getElementById('uploadBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!file) {
      showUploadStatus('Please select a file to upload', true);
      return;
    }

    if (!file.name.endsWith('.zip')) {
      showUploadStatus('Please select a ZIP file', true);
      return;
    }

    const formData = new FormData();
    formData.append('file', file);
    
    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Uploading...';
    
    try {
      const response = await fetch('/upload-dataset', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (response.ok) {
        showUploadStatus(`✓ File "${file.name}" uploaded successfully!`);
        fileInput.value = ''; // Clear the input
      } else {
        showUploadStatus(`Upload failed: ${result.error}`, true);
      }
    } catch (error) {
      showUploadStatus(`Upload failed: ${error.message}`, true);
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload';
    }
  });

  async function triggerJob(endpoint, jobName, formData) {
    document.getElementById('jobLoading').classList.remove('hidden');
    document.getElementById('metrics').textContent = `${jobName} job running...`;

    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      if (res.ok) {
        // Poll job status every 5s
        const poll = setInterval(async () => {
          const statusRes = await fetch(`/job-status/${jobName}`);
          const statusData = await statusRes.json();

          if (statusData.succeeded > 0) {
            clearInterval(poll);
            document.getElementById('jobLoading').classList.add('hidden');
            
            // Get detailed results for preprocess jobs
            if (jobName === 'preprocess') {
              try {
                const logsRes = await fetch(`/job-logs/${jobName}`);
                const logsData = await logsRes.json();
                
                if (logsData.preprocess_summary) {
                  displayPreprocessResults(logsData.preprocess_summary);
                } else {
                  document.getElementById('metrics').textContent = 'Preprocess job completed successfully.';
                }
              } catch (err) {
                document.getElementById('metrics').textContent = 'Preprocess job completed successfully.';
              }
            } else if (jobName === 'train') {
              // Handle training job completion with metrics
              try {
                const logsRes = await fetch(`/job-logs/${jobName}`);
                const logsData = await logsRes.json();
                
                if (logsData.training_summary) {
                  displayTrainingResults(logsData.training_summary);
                } else {
                  document.getElementById('metrics').textContent = 'Training job completed successfully.';
                }
              } catch (err) {
                document.getElementById('metrics').textContent = 'Training job completed successfully.';
              }
            } else {
              document.getElementById('metrics').textContent = `${jobName} job completed successfully.`;
            }
          }
          if (statusData.failed > 0) {
            clearInterval(poll);
            document.getElementById('jobLoading').classList.add('hidden');
            document.getElementById('metrics').textContent = `${jobName} job failed.`;
          }
        }, 5000); // Reduced to 5s for better responsiveness
      } else {
        document.getElementById('jobLoading').classList.add('hidden');
        document.getElementById('metrics').textContent = `Error: ${data.message}`;
      }
    } catch (err) {
      document.getElementById('jobLoading').classList.add('hidden');
      document.getElementById('metrics').textContent = `Error: ${err.message}`;
    }
  }

  function displayPreprocessResults(summary) {
    const metricsDiv = document.getElementById('metrics');
    
    if (summary.status === 'success' && Object.keys(summary.splits).length > 0) {
      let html = '<div class="preprocess-results">';
      html += '<h4 class="text-lg font-semibold text-green-600 mb-2">✅ Preprocess Completed Successfully</h4>';
      html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">';
      
      // Display each split
      for (const [splitName, stats] of Object.entries(summary.splits)) {
        html += `
          <div class="bg-gray-50 p-3 rounded-lg">
            <h5 class="font-medium text-gray-800 capitalize">${splitName} Split</h5>
            <div class="text-sm text-gray-600 mt-1">
              <div>📸 Images: <span class="font-medium">${stats.images}</span></div>
              <div>🏠 Polygons: <span class="font-medium">${stats.polygons}</span></div>
              <div>🔗 Pairs: <span class="font-medium">${stats.pairs}</span></div>
            </div>
          </div>
        `;
      }
      
      html += '</div>';
      html += `<div class="text-sm text-gray-700 border-t pt-2">
        <strong>Total:</strong> ${summary.total_images} images, ${summary.total_polygons} polygons
      </div>`;
      html += '</div>';
      
      metricsDiv.innerHTML = html;
    } else {
      metricsDiv.textContent = 'Preprocess job completed but no results found.';
    }
  }

  function displayTrainingResults(summary) {
    const metricsDiv = document.getElementById('metrics');
    
    if (summary.status === 'success' || summary.status === 'completed') {
      let html = '<div class="training-results">';
      html += '<h4 class="text-lg font-semibold text-green-600 mb-3">🎯 Training Completed Successfully</h4>';
      
      // Training Configuration
      if (summary.training_config) {
        html += '<div class="mb-4 p-3 bg-slate-700 rounded-lg">';
        html += '<h5 class="font-medium text-white mb-2">📋 Training Configuration</h5>';
        html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-slate-300">';
        html += `<div>Epochs: <span class="text-white font-medium">${summary.training_config.total_epochs || 'N/A'}</span></div>`;
        html += `<div>Image Size: <span class="text-white font-medium">${summary.training_config.image_size || 'N/A'}</span></div>`;
        html += `<div>Batch Size: <span class="text-white font-medium">${summary.training_config.batch_size || 'N/A'}</span></div>`;
        html += `<div>Device: <span class="text-white font-medium">${summary.training_config.device || 'N/A'}</span></div>`;
        html += `<div>Model: <span class="text-white font-medium">${summary.training_config.model || 'N/A'}</span></div>`;
        html += '</div></div>';
      }
      
      // Training Progress
      if (summary.epochs_completed > 0) {
        html += '<div class="mb-4 p-3 bg-slate-700 rounded-lg">';
        html += '<h5 class="font-medium text-white mb-2">📈 Training Progress</h5>';
        html += `<div class="text-sm text-slate-300">Completed: <span class="text-white font-medium">${summary.epochs_completed}/${summary.total_epochs} epochs</span></div>`;
        if (summary.epochs_completed === summary.total_epochs) {
          html += '<div class="text-xs text-green-400 mt-1">✅ All epochs completed</div>';
        }
        html += '</div>';
      }
      
      // Final Metrics
      if (summary.final_metrics && Object.keys(summary.final_metrics).length > 0) {
        html += '<div class="mb-4 p-3 bg-slate-700 rounded-lg">';
        html += '<h5 class="font-medium text-white mb-2">📊 Final Metrics</h5>';
        html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">';
        
        if (summary.final_metrics.mAP50 !== undefined) {
          html += `<div class="text-center p-2 bg-slate-600 rounded">
            <div class="text-xs text-slate-400">mAP@0.5</div>
            <div class="text-lg font-bold text-blue-400">${(summary.final_metrics.mAP50 * 100).toFixed(1)}%</div>
          </div>`;
        }
        
        if (summary.final_metrics.mAP50_95 !== undefined) {
          html += `<div class="text-center p-2 bg-slate-600 rounded">
            <div class="text-xs text-slate-400">mAP@0.5:0.95</div>
            <div class="text-lg font-bold text-blue-400">${(summary.final_metrics.mAP50_95 * 100).toFixed(1)}%</div>
          </div>`;
        }
        
        if (summary.final_metrics.precision !== undefined) {
          html += `<div class="text-center p-2 bg-slate-600 rounded">
            <div class="text-xs text-slate-400">Precision</div>
            <div class="text-lg font-bold text-green-400">${(summary.final_metrics.precision * 100).toFixed(1)}%</div>
          </div>`;
        }
        
        if (summary.final_metrics.recall !== undefined) {
          html += `<div class="text-center p-2 bg-slate-600 rounded">
            <div class="text-xs text-slate-400">Recall</div>
            <div class="text-lg font-bold text-green-400">${(summary.final_metrics.recall * 100).toFixed(1)}%</div>
          </div>`;
        }
        
        html += '</div>';
        
        // Loss metrics
        if (summary.final_metrics.total_loss !== undefined) {
          html += '<div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-slate-400">';
          html += `<div>Box Loss: <span class="text-white">${summary.final_metrics.box_loss?.toFixed(4) || 'N/A'}</span></div>`;
          html += `<div>Class Loss: <span class="text-white">${summary.final_metrics.cls_loss?.toFixed(4) || 'N/A'}</span></div>`;
          html += `<div>DFL Loss: <span class="text-white">${summary.final_metrics.dfl_loss?.toFixed(4) || 'N/A'}</span></div>`;
          html += `<div>Total Loss: <span class="text-white">${summary.final_metrics.total_loss?.toFixed(4) || 'N/A'}</span></div>`;
          html += '</div>';
        }
        
        html += '</div>';
      }
      
      // Model Information
      html += '<div class="mb-4 p-3 bg-slate-700 rounded-lg">';
      html += '<h5 class="font-medium text-white mb-2">🤖 Model Information</h5>';
      html += '<div class="text-sm text-slate-300 space-y-1">';
      
      if (summary.model_info && summary.model_info.parameters) {
        html += `<div>Parameters: <span class="text-white font-medium">${summary.model_info.parameters.toLocaleString()}</span></div>`;
      }
      
      if (summary.model_info && summary.model_info.layers) {
        html += `<div>Layers: <span class="text-white font-medium">${summary.model_info.layers}</span></div>`;
      }
      
      if (summary.published_path) {
        html += `<div>Published Model: <span class="text-white font-medium">${summary.published_path}</span></div>`;
        html += '<div class="text-xs text-green-400 mt-1">✅ Model available for inference</div>';
      } else if (summary.model_path) {
        html += `<div>Training Output: <span class="text-white font-medium">${summary.model_path}</span></div>`;
        html += '<div class="text-xs text-yellow-400 mt-1">⚠️ Model not yet published</div>';
      }
      
      html += '</div></div>';
      
      html += '</div>';
      metricsDiv.innerHTML = html;
    } else if (summary.status === 'error') {
      metricsDiv.innerHTML = `
        <div class="training-results">
          <h4 class="text-lg font-semibold text-red-600 mb-2">❌ Training Failed</h4>
          <div class="text-sm text-slate-400">Check logs for details.</div>
        </div>
      `;
    } else {
      metricsDiv.textContent = 'Training job completed but metrics could not be parsed.';
    }
  }

  // Preprocess button
  document.getElementById('btnPreprocess').addEventListener('click', (e) => {
    e.preventDefault();
    const formData = new FormData();
    // Use the uploaded filename from the last successful upload
    const fileInput = document.getElementById('fileInput');
    let datasetPath = "aiad_data.zip"; // default fallback
    
    // Check if there's an uploaded file name we can use
    const statusDiv = document.getElementById('uploadStatus');
    if (!statusDiv.classList.contains('hidden') && statusDiv.textContent.includes('uploaded successfully')) {
      // Extract filename from status message
      const match = statusDiv.textContent.match(/File "([^"]+)" uploaded successfully/);
      if (match) {
        datasetPath = `/data/raw/${match[1]}`;
      }
    }
    
    formData.append("dataset", datasetPath);
    triggerJob('/trigger-preprocess', 'preprocess', formData);
  });

  // Train button
  document.getElementById('btnTrain').addEventListener('click', (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append("epochs", document.getElementById('epochs').value);
    formData.append("batch", document.getElementById('batch').value);
    triggerJob('/trigger-train', 'train', formData);
  });

  // Model status functionality
  async function updateModelStatus() {
    try {
      const response = await fetch('/infer-status');
      const status = await response.json();
      
      const statusContent = document.getElementById('statusContent');
      let html = '';
      
      if (status.deployment_mode === 'canary') {
        html = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-3 bg-blue-900 rounded">
              <div class="text-blue-300 font-medium mb-1">📦 Current Model</div>
              <div class="text-slate-300 text-xs">Production traffic: ~50%</div>
            </div>
            <div class="p-3 bg-yellow-900 rounded">
              <div class="text-yellow-300 font-medium mb-1">🚀 Canary Model (v${status.canary_version?.version || 'Unknown'})</div>
              <div class="text-slate-300 text-xs">Testing traffic: ~50%</div>
              <div class="text-slate-300 text-xs mt-1">
                Runtime: ${status.canary_elapsed_minutes || 0} min 
                ${status.ready_for_promotion ? '✅ Ready for promotion' : '⏳ Evaluating...'}
              </div>
            </div>
          </div>
        `;
      } else {
        html = `
          <div class="p-3 bg-green-900 rounded">
            <div class="text-green-300 font-medium mb-1">✅ Production Model</div>
            <div class="text-slate-300 text-xs">
              ${status.current_model ? 'Model loaded and serving 100% traffic' : 'No model loaded'}
            </div>
          </div>
        `;
      }
      
      statusContent.innerHTML = html;
    } catch (error) {
      document.getElementById('statusContent').innerHTML = 
        '<div class="text-red-400 text-sm">Failed to load model status</div>';
    }
  }

  // Update status on page load and every 30 seconds
  updateModelStatus();
  setInterval(updateModelStatus, 30000);
</script>
{% endblock %}