{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto">
  <h1 class="text-3xl font-semibold text-white mb-6">Inference</h1>

  <!-- Single-Pair Inference -->
  <form id="inferForm"
        class="border border-slate-700 rounded-lg p-6 bg-slate-800 shadow-sm hover:shadow-md transition mb-8"
        enctype="multipart/form-data">
    <h2 class="text-xl font-medium text-slate-200 mb-4">Single-Pair Inference</h2>

    <div class="mb-4">
      <label class="block text-sm text-slate-300 mb-2">Select pre-disaster image</label>
      <input type="file" name="pre_disaster" accept="image/*"
             class="w-full border border-slate-600 bg-slate-900 text-white rounded p-2" required>
    </div>

    <div class="mb-4">
      <label class="block text-sm text-slate-300 mb-2">Select post-disaster image</label>
      <input type="file" name="post_disaster" accept="image/*"
             class="w-full border border-slate-600 bg-slate-900 text-white rounded p-2" required>
    </div>

    <button type="submit"
            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded">
      Predict
    </button>
  </form>

  <!-- 3-column result display -->
  <div id="singleResult" class="grid grid-cols-3 gap-4 mb-12">
    <div class="bg-slate-900 p-2 rounded text-center">
      <p class="text-slate-300 mb-2">Pre-Disaster</p>
      <img id="preImg" src="" alt="Pre-Disaster" class="w-full object-contain">
    </div>
    <div class="bg-slate-900 p-2 rounded text-center">
      <p class="text-slate-300 mb-2">Post-Disaster</p>
      <img id="postImg" src="" alt="Post-Disaster" class="w-full object-contain">
    </div>
    <div class="bg-slate-900 p-2 rounded text-center">
      <p class="text-slate-300 mb-2">Predicted Overlay</p>
      <img id="overlayImg"
           src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjx0ZXh0IHg9IjUwJSIgeT0iNTAiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIHRleHQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmaWxsPSIjN2M4Y2FkIj8/PjwvdGV4dD48L3N2Zz4="
           alt="Overlay" class="w-full object-contain">
    </div>
  </div>

  <!-- Batch Inference -->
  <form id="batchForm" enctype="multipart/form-data"
        class="border border-slate-700 rounded-lg p-6 bg-slate-800 shadow-sm hover:shadow-md transition">
    <h2 class="text-xl font-medium text-slate-200 mb-4">Batch Inference</h2>

    <input type="file" name="files" multiple required
           class="w-full border border-slate-600 bg-slate-900 text-white rounded p-2 mb-4">

    <!-- Show selected file/folder name -->
    <p id="batchFileName" class="text-slate-400 text-sm mb-4"></p>

    <!-- Loading bar -->
    <div id="batchLoading" class="hidden w-full bg-slate-700 rounded h-2 overflow-hidden mb-4">
      <div class="bg-teal-500 h-2 animate-pulse" style="width: 100%"></div>
    </div>

    <button type="submit"
            class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white rounded">
      Run Batch Inference
    </button>
  </form>

  <!-- Batch result link -->
  <div id="batchResult" class="mt-4 hidden">
    <p class="text-slate-300"> Batch inference completed. 
      <a id="batchDownloadLink" href="#" class="text-indigo-400 underline">Download results</a>
    </p>
  </div>
</div>

<!-- Scripts -->
<script>
  // --- Single inference ---
  document.getElementById('inferForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const preFile = e.target.querySelector('input[name="pre_disaster"]').files[0];
    const postFile = e.target.querySelector('input[name="post_disaster"]').files[0];
    if (!preFile || !postFile) return;

    // Show uploaded images immediately
    document.getElementById('preImg').src = URL.createObjectURL(preFile);
    document.getElementById('postImg').src = URL.createObjectURL(postFile);

    const fd = new FormData();
    fd.append('pre_disaster', preFile);
    fd.append('post_disaster', postFile);

    const res = await fetch('/infer-file', { method: 'POST', body: fd });
    const json = await res.json();

    if (json.overlay_png_base64) {
      document.getElementById('overlayImg').src = 'data:image/png;base64,' + json.overlay_png_base64;
    }
  });

  // --- Batch inference ---
  const batchInput = document.querySelector('#batchForm input[name="files"]');
  const batchFileName = document.getElementById('batchFileName');
  const batchLoading = document.getElementById('batchLoading');
  const batchResult = document.getElementById('batchResult');
  const batchDownloadLink = document.getElementById('batchDownloadLink');

  // Show selected file names
  batchInput.addEventListener('change', () => {
    const names = Array.from(batchInput.files).map(f => f.name);
    batchFileName.textContent = names.join(', ');
  });

  document.getElementById('batchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    batchLoading.classList.remove('hidden');
    batchResult.classList.add('hidden');

    const fd = new FormData();
    for (let file of batchInput.files) {
      fd.append('files', file);
    }

    const res = await fetch('/upload-batch', { method: 'POST', body: fd });
    const json = await res.json();

    batchLoading.classList.add('hidden');

    if (json.download_url) {
      batchDownloadLink.href = json.download_url;
      batchResult.classList.remove('hidden');
    }
  });
</script>
{% endblock %}